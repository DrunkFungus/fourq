#include "field.h"

// func pDbl2(a *point)
TEXT Â·pDbl2(SB),0,$168-8
	MOVQ a+0(FP), DI

	// A = X1^2
	feSquare(CX,R12,R13, 0(DI),8(DI),16(DI),24(DI), R8,R9,R10,R11)
	feMov(R8,R9,R10,R11, 0(SP),8(SP),16(SP),24(SP))

	// B = Y1^2
	feSquare(CX,R12,R13, 32(DI),40(DI),48(DI),56(DI), R8,R9,R10,R11)
	feMov(R8,R9,R10,R11, 32(SP),40(SP),48(SP),56(SP))

	// C = 2*Z1^2
	feSquare(CX,R12,R13, 64(DI),72(DI),80(DI),88(DI), R8,R9,R10,R11)
	feDbl(R8,R9,R10,R11)
	feMov(R8,R9,R10,R11, 64(SP),72(SP),80(SP),88(SP))

	// D = A + B
	feMov( 0(SP), 8(SP),16(SP),24(SP), R8,R9,R10,R11)
	feAdd(32(SP),40(SP),48(SP),56(SP), R8,R9,R10,R11)
	feMov(R8,R9,R10,R11, 128(DI),136(DI),144(DI),152(DI))

	// E = (X1 + Y1)^2 - D
	feMov( 0(DI), 8(DI),16(DI),24(DI), R8,R9,R10,R11)
	feAdd(32(DI),40(DI),48(DI),56(DI), R8,R9,R10,R11)
	feSquare(CX,BX,SI, R8,R9,R10,R11, R12,R13,R14,R15)

	feMov(128(DI),136(DI),144(DI),152(DI), R8,R9,R10,R11)
	feSub(R12,R13,R14,R15, R8,R9,R9,R11)

	feMov(R8,R9,R10,R11, 96(DI),104(DI),112(DI),120(DI))

	// F = B - A
	feMov( 0(SP), 8(SP),16(SP),24(SP), R8,R9,R10,R11)
	feSub(32(SP),40(SP),48(SP),56(SP), R8,R9,R10,R11)
	feMov(R8,R9,R10,R11, 96(SP),104(SP),112(SP),120(SP))

	// G = C - F
	feSub(64(SP),72(SP),80(SP),88(SP), R8,R9,R10,R11)
	feMov(R8,R9,R10,R11, 128(SP),136(SP),144(SP),152(SP))

	// X3 = E * G
	feMul(CX, 96(DI),104(DI),112(DI),120(DI), R8,R9,R10,R11, R12,R13,R14,R15)
	feMov(R12,R13,R14,R15, 0(DI),8(DI),16(DI),24(DI))

	// Y3 = D * F
	feMul(CX, 128(DI),136(DI),144(DI),152(DI), 96(SP),104(SP),112(SP),120(SP), R12,R13,R14,R15)
	feMov(R12,R13,R14,R15, 32(DI),40(DI),48(DI),56(DI))

	// Z3 = F * G
	feMul(CX, 96(SP),104(SP),112(SP),120(SP), 128(SP),136(SP),144(SP),152(SP), R12,R13,R14,R15)
	feMov(R12,R13,R14,R15, 64(DI),72(DI),80(DI),88(DI))

	RET
