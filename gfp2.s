// func feAdd(c, a, b *gfP2)
TEXT ·feAdd(SB),0,$0-24
	MOVQ a+8(FP), DI
	MOVQ b+16(FP), SI
	MOVQ 0(DI), AX
	MOVQ 8(DI), BX
	MOVQ 16(DI), CX
	MOVQ 24(DI), DX
	ADDQ 0(SI), AX
	ADCQ 8(SI), BX
	BTRQ $63, BX
	ADCQ $0, AX
	ADCQ $0, BX
	ADDQ 16(SI), CX
	ADCQ 24(SI), DX
	BTRQ $63, DX
	ADCQ $0, CX
	ADCQ $0, DX
	MOVQ c+0(FP), DI
	MOVQ AX, 0(DI)
	MOVQ BX, 8(DI)
	MOVQ CX, 16(DI)
	MOVQ DX, 24(DI)
	RET

// func feSub(c, a, b *gfP2)
TEXT ·feSub(SB),0,$0-24
	MOVQ a+8(FP), DI
	MOVQ b+16(FP), SI
	MOVQ 0(SI), AX
	MOVQ 8(SI), BX
	MOVQ 16(SI), CX
	MOVQ 24(SI), DX
	NOTQ AX
	NOTQ BX
	BTRQ $63, BX
	NOTQ CX
	NOTQ DX
	BTRQ $63, DX
	ADDQ 0(DI), AX
	ADCQ 8(DI), BX
	BTRQ $63, BX
	ADCQ $0, AX
	ADCQ $0, BX
	ADDQ 16(DI), CX
	ADCQ 24(DI), DX
	BTRQ $63, DX
	ADCQ $0, CX
	ADCQ $0, DX
	MOVQ c+0(FP), DI
	MOVQ AX, 0(DI)
	MOVQ BX, 8(DI)
	MOVQ CX, 16(DI)
	MOVQ DX, 24(DI)
	RET

// func feMul(c, a, b *fieldElem)
TEXT ·feMul(SB),0,$0-24
	MOVQ a+8(FP), DI
	MOVQ b+16(FP), SI
	MOVQ $0, CX
	MOVQ 16(DI), AX
	MULQ 16(SI)
	MOVQ AX, R8
	MOVQ DX, R9
	MOVQ 16(DI), AX
	MULQ 24(SI)
	SHLQ $1, DX
	ADDQ DX, R8
	ADCQ AX, R9
	ADCQ $0, CX
	MOVQ 24(DI), AX
	MULQ 16(SI)
	SHLQ $1, DX
	ADDQ DX, R8
	ADCQ AX, R9
	ADCQ $0, CX
	MOVQ 24(DI), AX
	MULQ 24(SI)
	SHLQ $1, DX
	SHLQ $1, AX
	ADCQ $0, DX
	ADDQ AX, R8
	ADCQ DX, R9
	ADCQ $0, CX
	SHLQ $1, CX
	BTRQ $63, R9
	ADCQ CX, R8
	ADCQ $0, R9
	BTRQ $63, R9
	ADCQ $0, R8
	ADCQ $0, R9
	NOTQ R8
	NOTQ R9
	BTRQ $63, R9
	MOVQ $0, CX
	MOVQ 0(DI), AX
	MULQ 0(SI)
	ADDQ AX, R8
	ADCQ DX, R9
	ADCQ $0, CX
	MOVQ 0(DI), AX
	MULQ 8(SI)
	SHLQ $1, DX
	ADDQ DX, R8
	ADCQ AX, R9
	ADCQ $0, CX
	MOVQ 8(DI), AX
	MULQ 0(SI)
	SHLQ $1, DX
	ADDQ DX, R8
	ADCQ AX, R9
	ADCQ $0, CX
	MOVQ 8(DI), AX
	MULQ 8(SI)
	SHLQ $1, DX
	SHLQ $1, AX
	ADCQ $0, DX
	ADDQ AX, R8
	ADCQ DX, R9
	ADCQ $0, CX
	SHLQ $1, CX
	BTRQ $63, R9
	ADCQ CX, R8
	ADCQ $0, R9
	BTRQ $63, R9
	ADCQ $0, R8
	ADCQ $0, R9
	MOVQ $0, CX
	MOVQ 0(DI), AX
	MULQ 16(SI)
	MOVQ AX, R10
	MOVQ DX, R11
	MOVQ 0(DI), AX
	MULQ 24(SI)
	SHLQ $1, DX
	ADDQ DX, R10
	ADCQ AX, R11
	ADCQ $0, CX
	MOVQ 8(DI), AX
	MULQ 16(SI)
	SHLQ $1, DX
	ADDQ DX, R10
	ADCQ AX, R11
	ADCQ $0, CX
	MOVQ 8(DI), AX
	MULQ 24(SI)
	SHLQ $1, DX
	SHLQ $1, AX
	ADCQ $0, DX
	ADDQ AX, R10
	ADCQ DX, R11
	ADCQ $0, CX
	SHLQ $1, CX
	BTRQ $63, R11
	ADCQ CX, R10
	ADCQ $0, R11
	BTRQ $63, R11
	ADCQ $0, R10
	ADCQ $0, R11
	MOVQ $0, CX
	MOVQ 16(DI), AX
	MULQ 0(SI)
	ADDQ AX, R10
	ADCQ DX, R11
	ADCQ $0, CX
	MOVQ 16(DI), AX
	MULQ 8(SI)
	SHLQ $1, DX
	ADDQ DX, R10
	ADCQ AX, R11
	ADCQ $0, CX
	MOVQ 24(DI), AX
	MULQ 0(SI)
	SHLQ $1, DX
	ADDQ DX, R10
	ADCQ AX, R11
	ADCQ $0, CX
	MOVQ 24(DI), AX
	MULQ 8(SI)
	SHLQ $1, DX
	SHLQ $1, AX
	ADCQ $0, DX
	ADDQ AX, R10
	ADCQ DX, R11
	ADCQ $0, CX
	SHLQ $1, CX
	BTRQ $63, R11
	ADCQ CX, R10
	ADCQ $0, R11
	BTRQ $63, R11
	ADCQ $0, R10
	ADCQ $0, R11
	MOVQ c+0(FP), DI
	MOVQ R8, 0(DI)
	MOVQ R9, 8(DI)
	MOVQ R10, 16(DI)
	MOVQ R11, 24(DI)
	RET

// func feSquare(c, a *fieldElem)
TEXT ·feSquare(SB),0,$0-16
	MOVQ a+8(FP), DI
	MOVQ 0(DI), R10
	MOVQ 8(DI), R11
	ADDQ 16(DI), R10
	ADCQ 24(DI), R11
	BTRQ $63, R11
	ADCQ $0, R10
	ADCQ $0, R11
	MOVQ 16(DI), R12
	MOVQ 24(DI), R13
	NOTQ R12
	NOTQ R13
	BTRQ $63, R13
	ADDQ 0(DI), R12
	ADCQ 8(DI), R13
	BTRQ $63, R13
	ADCQ $0, R12
	ADCQ $0, R13
	MOVQ $0, CX
	MOVQ R10, AX
	MULQ R12
	MOVQ AX, R8
	MOVQ DX, R9
	MOVQ R10, AX
	MULQ R13
	SHLQ $1, DX
	ADDQ DX, R8
	ADCQ AX, R9
	ADCQ $0, CX
	MOVQ R11, AX
	MULQ R12
	SHLQ $1, DX
	ADDQ DX, R8
	ADCQ AX, R9
	ADCQ $0, CX
	MOVQ R11, AX
	MULQ R13
	SHLQ $1, DX
	SHLQ $1, AX
	ADCQ $0, DX
	ADDQ AX, R8
	ADCQ DX, R9
	ADCQ $0, CX
	SHLQ $1, CX
	BTRQ $63, R9
	ADCQ CX, R8
	ADCQ $0, R9
	BTRQ $63, R9
	ADCQ $0, R8
	ADCQ $0, R9
	MOVQ $0, CX
	MOVQ 0(DI), AX
	MULQ 16(DI)
	MOVQ AX, R10
	MOVQ DX, R11
	MOVQ 0(DI), AX
	MULQ 24(DI)
	SHLQ $1, DX
	ADDQ DX, R10
	ADCQ AX, R11
	ADCQ $0, CX
	MOVQ 8(DI), AX
	MULQ 16(DI)
	SHLQ $1, DX
	ADDQ DX, R10
	ADCQ AX, R11
	ADCQ $0, CX
	MOVQ 8(DI), AX
	MULQ 24(DI)
	SHLQ $1, DX
	SHLQ $1, AX
	ADCQ $0, DX
	ADDQ AX, R10
	ADCQ DX, R11
	ADCQ $0, CX
	SHLQ $1, CX
	BTRQ $63, R11
	ADCQ CX, R10
	ADCQ $0, R11
	BTRQ $63, R11
	ADCQ $0, R10
	ADCQ $0, R11
	SHLQ $1, R11
	SHLQ $1, R10
	ADCQ $0, R11
	BTRQ $63, R11
	ADCQ $0, R10
	ADCQ $0, R11
	MOVQ c+0(FP), DI
	MOVQ R8, 0(DI)
	MOVQ R9, 8(DI)
	MOVQ R10, 16(DI)
	MOVQ R11, 24(DI)
	RET

// func feInvert(c, a *gfP2)
TEXT ·feInvert(SB),0,$0-16
	MOVQ a+8(FP), DI
	MOVQ 0(DI), R8
	MOVQ 8(DI), R9
	MOVQ $0, R14
	MOVQ R8, AX
	MULQ R8
	MOVQ AX, R12
	MOVQ DX, R13
	MOVQ R8, AX
	MULQ R9
	SHLQ $1, DX
	ADDQ DX, R12
	ADCQ AX, R13
	ADCQ $0, R14
	ADDQ DX, R12
	ADCQ AX, R13
	ADCQ $0, R14
	MOVQ R9, AX
	MULQ R9
	SHLQ $1, DX
	SHLQ $1, AX
	ADCQ $0, DX
	ADDQ AX, R12
	ADCQ DX, R13
	ADCQ $0, R14
	SHLQ $1, R14
	BTRQ $63, R13
	ADCQ R14, R12
	ADCQ $0, R13
	BTRQ $63, R13
	ADCQ $0, R12
	ADCQ $0, R13
	MOVQ 16(DI), R8
	MOVQ 24(DI), R9
	MOVQ $0, R14
	MOVQ R8, AX
	MULQ R8
	ADDQ AX, R12
	ADCQ DX, R13
	ADCQ $0, R14
	MOVQ R8, AX
	MULQ R9
	SHLQ $1, DX
	ADDQ DX, R12
	ADCQ AX, R13
	ADCQ $0, R14
	ADDQ DX, R12
	ADCQ AX, R13
	ADCQ $0, R14
	MOVQ R9, AX
	MULQ R9
	SHLQ $1, DX
	SHLQ $1, AX
	ADCQ $0, DX
	ADDQ AX, R12
	ADCQ DX, R13
	ADCQ $0, R14
	SHLQ $1, R14
	BTRQ $63, R13
	ADCQ R14, R12
	ADCQ $0, R13
	BTRQ $63, R13
	ADCQ $0, R12
	ADCQ $0, R13
	MOVQ $1, R8
	MOVQ $0, R9
	MOVQ $0, R10
	MOVQ $0, R11
	MOVQ $0, R14
	MOVQ $0, R15
	NOTQ R14
	NOTQ R15
	BTRQ $63, R15

reduce:
	BSFQ R12, CX
	JNZ common
	BSFQ R13, CX
	JZ end
	MOVQ R13, R12
	MOVQ $0, R13
	SHLQ $1, R9
	XCHGQ R8, R9
	SHRQ $1, R8:R9
	SHRQ $1, R9

common:
	SHRQ CL, R12:R13
	SHRQ CL, R13
	MOVQ $0, BX
	SHRQ CL, BX:R8
	SHRQ CL, R8:R9
	SHRQ CL, R9
	SHRQ $1, BX
	XORQ BX, R9
	CMPQ R12, $1
	JNE cont
	CMPQ R13, $0
	JE end

cont:
	MOVQ R9, AX
	MOVQ R13, BX
	XADDQ R10, R8
	ADCQ R11, R9
	BTRQ $63, R9
	ADCQ $0, R8
	ADCQ $0, R9
	XADDQ R14, R12
	ADCQ R15, R13
	MOVQ AX, R11
	MOVQ BX, R15
	JMP reduce

end:
	MOVQ c+0(FP), SI
	MOVQ 0(DI), R10
	MOVQ 8(DI), R11
	MOVQ $0, R14
	MOVQ R8, AX
	MULQ R10
	MOVQ AX, R12
	MOVQ DX, R13
	MOVQ R8, AX
	MULQ R11
	SHLQ $1, DX
	ADDQ DX, R12
	ADCQ AX, R13
	ADCQ $0, R14
	MOVQ R9, AX
	MULQ R10
	SHLQ $1, DX
	ADDQ DX, R12
	ADCQ AX, R13
	ADCQ $0, R14
	MOVQ R9, AX
	MULQ R11
	SHLQ $1, DX
	SHLQ $1, AX
	ADCQ $0, DX
	ADDQ AX, R12
	ADCQ DX, R13
	ADCQ $0, R14
	SHLQ $1, R14
	BTRQ $63, R13
	ADCQ R14, R12
	ADCQ $0, R13
	BTRQ $63, R13
	ADCQ $0, R12
	ADCQ $0, R13
	MOVQ R12, 0(SI)
	MOVQ R13, 8(SI)
	MOVQ 16(DI), R10
	MOVQ 24(DI), R11
	NOTQ R10
	NOTQ R11
	BTRQ $63, R11
	MOVQ $0, R14
	MOVQ R8, AX
	MULQ R10
	MOVQ AX, R12
	MOVQ DX, R13
	MOVQ R8, AX
	MULQ R11
	SHLQ $1, DX
	ADDQ DX, R12
	ADCQ AX, R13
	ADCQ $0, R14
	MOVQ R9, AX
	MULQ R10
	SHLQ $1, DX
	ADDQ DX, R12
	ADCQ AX, R13
	ADCQ $0, R14
	MOVQ R9, AX
	MULQ R11
	SHLQ $1, DX
	SHLQ $1, AX
	ADCQ $0, DX
	ADDQ AX, R12
	ADCQ DX, R13
	ADCQ $0, R14
	SHLQ $1, R14
	BTRQ $63, R13
	ADCQ R14, R12
	ADCQ $0, R13
	BTRQ $63, R13
	ADCQ $0, R12
	ADCQ $0, R13
	MOVQ R12, 16(SI)
	MOVQ R13, 24(SI)
	RET
